@model IList<ACS.Core.DTOs.MessageDTO>
@using Syncfusion.EJ2
@inject ACS.Core.Interfaces.Services.IOrgnaizationServices<Organization> _organizationService

@{
    var asyncSettings = new Syncfusion.EJ2.Inputs.UploaderAsyncSettings { SaveUrl = @Url.Content("~/Messages/SaveFile") };
    var asyncSettingsForTempFiles = new Syncfusion.EJ2.Inputs.UploaderAsyncSettings { SaveUrl = @Url.Content("~/Messages/SaveTempFile") };
}

@section TimelineStyle {
    <link href="@Url.Content("~/css/timeline.css")" rel="stylesheet" type="text/css" />
}
    <style>
        /***********************Message recipts style*******************************/

        .tooltipp {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
        }

            .tooltipp .tooltipptext {
                visibility: hidden;
                width: 120px;
                background-color: black;
                color: #fff;
                text-align: center;
                border-radius: 4px;
                padding: 5px 0;
                /* Position the tooltip */
                position: absolute;
                z-index: 1;
            }

            .tooltipp:hover .tooltipptext {
                visibility: visible;
            }


        /****************************Comments Scroller****************************/

        .scroller {
            height: 70vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
        }

            .scroller .scrollerStart {
                scroll-snap-align: start;
            }
    </style>
    @{
    var OriginalMessage = Model.FirstOrDefault(m => m.IsOrigin == true && m.OriginMessageId == m.Id.ToString());
    if (OriginalMessage == null)
        OriginalMessage = Model.FirstOrDefault(m => m.IsOrigin == true);
    var CommentsMessage = Model.Where(m => m.IsOrigin == false && m.OriginMessageId == OriginalMessage.Id.ToString()).ToList();
    IEnumerable<Organization> OrganizationsList = await _organizationService.GetOrgnaizationsByFileNumber(@ViewBag.CurrentUserFileNumber);
}

<div class="container mt-1">
    @*<a href="mailto:?subject=I wanted you to see this site&amp;body=Check out this site http://www.website.com."
    title="Share by Email">
    <img src="http://png-2.findicons.com/files/icons/573/must_have/48/mail.png">
    </a>*@
    <div class="row e-rtl">
        <div class="col-md-5">
            <div class="e-rtl bg-secondary mb-1 mt-2 rounded">
                <b class="text-white bg-dark rounded"> من: </b>@Html.Raw("&nbsp;")
                <div class="tooltipp text-white font-weight-bolder">
                    @Html.Raw(OriginalMessage.SenderDiscription)
                    @if (OriginalMessage.SenderDiscription != OriginalMessage.SenderFullName)
                    {
                        <span class="tooltipptext">@OriginalMessage.SenderFullName</span>
                    }
                </div>
            </div>
            <div class="e-rtl bg-secondary mb-1 mt-2 rounded">
                <b class="text-white bg-dark rounded"> إلى: </b>@Html.Raw("&nbsp;")
                @{
                    int i = 0;
                    foreach (var package in OriginalMessage.Packages.Where(l => l.IsCC == false).ToList())
                    {
                        if (i <= 1)
                        {
                            <div class="tooltipp text-white font-weight-bolder">
                                @Html.Raw(package.RecipintDiscription)
                                @if (package.RecipintDiscription != package.Recipint.FullName)
                                {
                                    <span class="tooltipptext">@Html.Raw(package.Recipint.FullName)</span>
                                }
                            </div>
                            @Html.Raw("&nbsp;")
                        }
                        else if (i > 1)
                        {
                            <b class="text-white bg-dark rounded">
                                <a href="#" onclick="ShowAllRecipintsModal('@OriginalMessage.Id', 'false');">إظهار الكل @OriginalMessage.Packages.Where(l => l.IsCC == false).ToList().Count</a>
                            </b>
                            break;
                        }
                        i++;
                    }
                }
            </div>

            <div class="e-rtl bg-secondary mt-2 rounded">
                <b class="text-white bg-dark rounded"> صورة إلى: </b>@Html.Raw("&nbsp;")
                @{
                    int j = 0;
                    foreach (var package in OriginalMessage.Packages.Where(l => l.IsCC == true).ToList())
                    {
                        if (j <= 1)
                        {
                            <div class="tooltipp text-white font-weight-bolder">
                                @Html.Raw(package.RecipintDiscription)
                                @if (package.RecipintDiscription != package.Recipint.FullName)
                                {
                                    <span class="tooltipptext">@Html.Raw(package.Recipint.FullName)</span>
                                }
                            </div>
                            @Html.Raw("&nbsp;")
                        }
                        else if (j > 1)
                        {
                            <b class="text-white bg-dark rounded">
                                <a href="#" onclick="ShowAllRecipintsModal('@OriginalMessage.Id', 'true');">إظهار الكل @OriginalMessage.Packages.Where(l => l.IsCC == true).ToList().Count</a>
                            </b>
                            break;
                        }
                        j++;
                    }
                }
            </div>

            <hr />

            <div class="e-rtl mt-3 text-center">
                @if (ViewBag.IsCommentable == true)
                {
                    @if (OriginalMessage.SerialNumber == null)
                    {
                        <button onclick="ShowModal_forward('@OriginalMessage.Id','0', '0')" type="button" class="btn btn-primary"><b>التأشير على المراسلة وإحالتها</b></button>
                    }
                    else
                    {
                        @if (OrganizationsList.Count() == 0 || OrganizationsList == null)
                        {
                            <button onclick="ShowModal_forward('@OriginalMessage.Id','@ViewBag.CurrentUserResponsibilityCode', '@ViewBag.CurrentUserDesignationId')" type="button" class="btn btn-primary"><b>التأشير على المراسلة وإحالتها</b></button>
                        }
                        else
                        {
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-placement="bottom"><b>التأشير على المراسلة وإحالتها</b></button>

                                <div class="dropdown-menu dropdown-menu-right e-rtl">
                                    <button onclick="ShowModal_forward('@OriginalMessage.Id','@ViewBag.CurrentUserResponsibilityCode', '@ViewBag.CurrentUserDesignationId')" class="dropdown-item" type="button">@ViewBag.CurrentUserJobtypeName</button>
                                    @foreach (var Organization in OrganizationsList)
                                    {
                                        <button onclick="ShowModal_forward('@OriginalMessage.Id','@Organization.ResponsibilityCode','@Organization.DesignationId')" class="dropdown-item" type="button">@Organization.Description</button>
                                    }
                                </div>
                            </div>
                        }
                    }
                }
                else
                {
                    <button onclick="alert('لا يمكن التعليق على المراسلة!');" type="button" class="btn btn-primary"><b>التأشير على المراسلة وإحالتها</b></button>
                }
                
                @if (ViewBag.IsDeletable == true)
                {
                    <a class="btn btn-danger" asp-action="DeleteMessage" asp-controller="Messages" asp-route-MessageId="@OriginalMessage.Id" onclick="return confirm('هل تريد بالفعل نقل المراسلة إلى المحذوفة؟');">حذف</a>
                }
                    @*
            /////////////////////REPLY BUTTON///////////////////
            @if (ViewBag.IsReplyable == true)
            {
                //<a class="btn btn-light" asp-action="ReplyMessage" asp-route-id="@OriginalMessage.Id" data-toggle="tooltip" data-placement="bottom" title="رد على المراسلة">
                //    <i class="fa fa-reply" aria-hidden="true"></i>
                //</a>
                <button asp-action="ReplyMessage" asp-route-id="@OriginalMessage.Id" type="button" class="btn p-4" style="background-color:#5adbb5;"><b>رد</b></button>
            }
            else
            {
                <button onclick="alert('لا يمكن الرد على المراسلة!');" type="button" class="btn p-4" style="background-color:#5adbb5;"><b>رد</b></button>
            }
                    *@

                    @*
            ////////////////////ORIGINAL MESSAGE BUTTON///////////////////////
            @if (OriginalMessage.Id.ToString() != OriginalMessage.OriginMessageId && OriginalMessage.OriginMessageId != null)
            {
                //<a class="btn btn-dark font-weight-bold" asp-action="Message" asp-route-Id="@OriginalMessage.OriginMessageId" data-toggle="tooltip" data-placement="bottom" title="عرض المراسلة الأصلية">المراسلة الأصلية</a>

                <button asp-action="Message" asp-route-Id="@OriginalMessage.OriginMessageId" type="button" class="btn p-4" style="background-color:#55c2da;"><b>عرض المراسلة الأصلية</b></button>
            }
            else
            {
                <button onclick="alert('هذه المراسلة أصلية!');" type="button" class="btn p-4" style="background-color:#55c2da;"><b>عرض المراسلة الأصلية</b></button>
            }
                    *@
                </div>

            <!--<div class="e-rtl text-center">
                <button type="button" class="btn p-4" style="background-color:#a881af;"><b>تعليق وإحالة</b></button>
                <button type="button" class="btn p-4" style="background-color:#5adbb5;"><b>رد</b></button>
                <button type="button" class="btn p-4" style="background-color:#55c2da;"><b>عرض المراسلة الأصلية</b></button>
            </div>-->

            <hr />

            <div class="mt-3 p-1 e-rtl border rounded">
                <b class="mt-0 rounded d-block">
                    المرفقات
                </b>
                @foreach (var attach in OriginalMessage.Documents.Where(d => d.IsTemp == true))
                {
                    <a class="d-block pe-auto" asp-action="DownloadAttach" asp-route-fileName="@attach.Id" asp-controller="Messages">
                        <span class="badge badge-secondary">@attach.Name</span>
                    </a>
                }

                @foreach (var CommentMessage in CommentsMessage)
                {
                    @foreach (var attach in CommentMessage.Documents.Where(d => d.IsTemp == true))
                    {
                        <a class="d-block pe-auto" asp-action="DownloadAttach" asp-route-fileName="@attach.Id" asp-controller="Messages">
                            <span class="badge badge-secondary">@attach.Name</span>
                        </a>
                    }
                }
            </div>

            @*
            <div class="mt-2 p-1 e-rtl border rounded">
                <b class="mt-0 rounded d-block">
                    <!--<b class="text-white mt-0 bg-dark rounded d-block">-->
                    مرفقات التعليقات
                </b>
                @foreach (var CommentMessage in CommentsMessage)
                {
                    @foreach (var attach in CommentMessage.Documents.Where(d => d.IsTemp == true))
                    {
                        <a class="d-inline pe-auto" asp-action="DownloadAttach" asp-route-fileName="@attach.Id" asp-controller="Messages">
                            <span class="badge badge-secondary">@attach.Name</span>
                        </a>
                    }
                }
            </div>
            *@
            <hr />

            <div class="mt-2">
                <ejs-chiplist id="chipCategories" enableRtl>
                    <e-chips>
                        @foreach (var cat in OriginalMessage.MessagesCategories)
                        {
                            <e-chip text="@cat.CategoryName" enabled="true"></e-chip>
                        }
                    </e-chips>
                </ejs-chiplist>
            </div>
        </div>
        <!-------------------------------------------------->
        <div class="col-md-7">
            <div class="mt-2 embed-responsive embed-responsive-4by3 rounded">
                <object data="@ViewBag.Path" type="application/pdf">
                </object>
            </div>
        </div>
    </div>
</div>

<!--<hr /><hr />-->
<div class="modal fade e-rtl" id="ForwardModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content container">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">التعليق على المراسلة وتحويلها</h5>
                <button type="button" class="close" data-dismiss="modal" style="position:absolute;left:0;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body e-rtl">
                <div id="BodyDiv">
                </div>
                <div class="row">
                    <div class="col-12">
                        <ul class="nav nav-tabs e-rtl" role="tablist">
                            <li class="nav-item">
                                <a style="color: black;font-size:18px; font-weight:900;" class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab" onclick="selectTextOrCopy('True')" id="textMessage">تعليق نصي</a>
                            </li>
                            <li class="nav-item">
                                <a style="color: black;font-size:18px; font-weight:900;" class="nav-link" data-toggle="tab" href="#tabs-2" role="tab" onclick="selectTextOrCopy('False')" id="copyMessage">نسخة ورقية (PDF , JPG)</a>
                            </li>

                            <li class="row mt-2">
                                <div>
                                    <b style="color: red;font-size:14px; font-weight:900;"> تنبيه... عند اختيار مراسلة نصية ، وللحصول على أفضل النتائج يستحسن الكتابة في المكان المخصص مباشرةً وعدم استخدام خاصية  النسخ واللصق</b>
                                </div>
                            </li>

                        </ul>
                        <div class="tab-content">

                            <div class="tab-pane active" id="tabs-1" role="tabpanel">
                                <textarea class="form-control mt-2" id="body_f" placeholder="نص التعليق"></textarea>
                            </div>

                            <div class="tab-pane" id="tabs-2" role="tabpanel">
                                <ejs-uploader selected="onFileSelected" allowedExtensions=".pdf,.jpg,.jpeg" enableRtl="true" id="UploadFiles" autoUpload="false" dropArea=".control-fluid" asyncSettings="@asyncSettings">
                                </ejs-uploader>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <ejs-uploader selected="onTempFileSelected" enableRtl="true" id="UploadTempFiles" autoUpload="false" dropArea=".control-fluid" asyncSettings="@asyncSettingsForTempFiles">
                    </ejs-uploader>
                </div>
            </div>
            <div class="modal-footer">
                <a class="btn btn-dark btn-lg w-100" onclick="checkThenSend()" id="forward" href="#"><i class="fa fa-paper-plane" aria-hidden="true"></i></a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade e-rtl" id="AllRecipintsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm">
        -->
        @*style=" max-width:1000px !important;"*@
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">المستلمين</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position:absolute;left:0;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body e-rtl" id="AllRecipintsModalBody">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="sendingModal" tabindex="-1" role="alert" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="alert">
        <div class="modal-content ">
            <div class="modal-body" style="position: relative;min-height: 200px; background-color:darkgrey">
                <div class="containerr">
                    <div class="box">
                        <div class="border one"></div>
                        <div class="border two"></div>
                        <div class="border three"></div>
                        <div class="border four"></div>

                        <div class="line one"></div>
                        <div class="line two"></div>
                        <div class="line three"></div>
                    </div>
                </div><div class="containerr">
                    <div class="box">
                        <div class="border one"></div>
                        <div class="border two"></div>
                        <div class="border three"></div>
                        <div class="border four"></div>

                        <div class="line one"></div>
                        <div class="line two"></div>
                        <div class="line three"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function ShowModal_forward(id, respCode, designationId) {
        var url = "/Messages/ForwardMessage?Id=" + id + "&respCode=" + respCode + "&designationId=" + designationId;
        $("#BodyDiv").load(url, function () {
            $("#ForwardModal").appendTo("body");
            $('#ForwardModal').on('shown.bs.modal', function () {
                $('.chosen-select-rtl', this).chosen('destroy').chosen({ rtl: true });
            });
            $("#ForwardModal").modal("show");
        })

        var uploaderObj = document.getElementById("UploadFiles").ej2_instances[0];
        uploaderObj.setProperties({
            buttons: {
                browse: 'إدراج النسخة الورقية',
                clear: 'حذف الكل',
                upload: ''
            }
        })
        var uploaderObj = document.getElementById("UploadTempFiles").ej2_instances[0];
        uploaderObj.setProperties({
            buttons: {
                browse: 'إرفاق ملف إضافي',
                clear: 'حذف الكل',
                upload: ''
            }
        })
    };

    function ShowModal_qr() {
        $("#QRModal").appendTo("body");
        $("#QRModal").modal("show");
    };

    function chipClick(value) {
        window.location = "@Url.RouteUrl(new { Controller = "Messages", Action = "DownloadAttach"})/?fileName=" + value;

    };

    function ShowAllRecipintsModal(id, CC) {
        var url = "/Messages/ShowMessageAllRecipints?Id=" + id + "&CC=" + CC;
        $("#AllRecipintsModalBody").load(url, function () {
            $("#AllRecipintsModal").appendTo("body");
            $("#AllRecipintsModal").modal("show");
        })
    };

    //function ShowModal_r() {
    //    $("#ReplyModal").appendTo("body");
    //    $('#ReplyModal').on('shown.bs.modal', function () {
    //        $('.chosen-select-rtl', this).chosen('destroy').chosen({ rtl: true });
    //    });
    //};

    //function ShowModal_h(id) {
    //    //$("#HistoryModal").appendTo("body");
    //    //$("#HistoryModal").modal("show");
    //    var url = "/Messages/MessageMovements?Id=" + id;
    //    $("#BodyDiv").load(url, function () {
    //        $("#HistoryModal").appendTo("body");
    //        $("#HistoryModal").modal("show");
    //    })
    //};

    function checkThenSend() {
        if (validateForwardForm() == false)
            return false;
        else {
            $("#sendingModal").appendTo("body");
            $("#sendingModal").modal({ backdrop: 'static', keyboard: false }, 'show');
            forward('@OriginalMessage.SerialNumber')
        }
    };
</script>
<script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
</script>



